# Temporary HTTP-only nginx config for SSL certificate issuance
# This serves ACME challenges and minimal functionality until SSL certs are issued

user  nginx;
worker_processes  auto;

events {
	worker_connections  1024;
}

http {
	include       /etc/nginx/mime.types;
	default_type  application/octet-stream;

	sendfile        on;
	tcp_nopush      on;
	tcp_nodelay     on;
	keepalive_timeout  65s;

	# Rate limit zone (per IP)
	limit_req_zone $binary_remote_addr zone=req_per_ip:10m rate=10r/s;

	# HTTP server: serve ACME challenge and basic functionality
	server {
		listen 80;
		server_name nirvana.bm www.nirvana.bm app.nirvana.bm admin.nirvana.bm;

		# ACME challenge handling - critical for certificate issuance
		location ^~ /.well-known/acme-challenge/ {
			root /var/www/certbot;
			try_files $uri =404;
			access_log off;
		}

		# Basic health check
		location = /health {
			access_log off;
			return 200 "nginx temporary config active\n";
			add_header Content-Type text/plain;
		}

		# Temporary redirect for all other requests
		location / {
			limit_req zone=req_per_ip burst=5 nodelay;
			return 503 "SSL certificates are being issued. Please wait...";
			add_header Content-Type text/plain;
			add_header Retry-After 60;
		}
	}
}
